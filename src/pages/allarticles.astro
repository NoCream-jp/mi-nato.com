---
import { getCollection } from "astro:content";
import ArticleCard from "../components/ArticleCard.astro";
import ExternalLinkButton from "../components/ExternalLinkButton.astro";
import InternalLinkButton from "../components/InternalLinkButton.astro";

const allArticles = await getCollection("article");
// slice(0, 5) を削除して全件取得
const sortedArticles = allArticles.sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

// 表示されている記事からユニークなカテゴリーを抽出
const categories = [
  ...new Set(sortedArticles.map((article) => article.data.category)),
];
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="description" content="All Articles - mi-nato.com" />
    <meta name="generator" content={Astro.generator} />
    <meta name="theme-color" content="#4968bd" />
    <title>All Articles - mi-nato.com</title>

    <link rel="stylesheet" href="/styles/index.css" />

    <!-- favicon設置, theme-color -->
    <link rel="icon" href="/favicon.ico" />
    <meta name="theme-color" content="#3a549c" />

    <!-- Font Awesome の読み込み -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- Google Fonts の読み込み -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Gothic+A1&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Zalando+Sans:ital,wght@0,200..900;1,200..900&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header class="header">
      <div class="header-left">
        <a href="/">mi-nato.com</a>
      </div>
      <div class="header-right">
        <a href="/">Home</a>
        <a href="/#about">About</a>
        <a href="/#works">Works</a>
        <a href="/#studies">Studies</a>
      </div>
    </header>

    <div class="articles-section section" id="articles">
      <div class="section-header">
        <div class="section-title">All Articles</div>
        <div class="toolbar">
          <div class="filter-dropdown">
            <button id="tag-filter-button" class="filter-button"
              >Tag <i class="fa-solid fa-caret-down"></i></button
            >
            <div id="tag-dropdown-content" class="dropdown-content">
              <button class="dropdown-item" data-category="all">All</button>
              {
                categories.map((cat) => (
                  <button class="dropdown-item" data-category={cat}>
                    {cat}
                  </button>
                ))
              }
            </div>
          </div>
        </div>
      </div>
      <div class="article-card-container">
        {
          sortedArticles.map((article, index) => (
            <div
              class:list={[
                "article-filter-item",
                { "last-visible": index === sortedArticles.length - 1 },
              ]}
              data-category={article.data.category}
              style="display: contents;"
            >
              <ArticleCard
                href={`/article/${article.slug}`}
                thumbnail={article.data.thumbnail}
                title={article.data.title}
                category={article.data.category}
                date={article.data.date.toLocaleDateString("ja-JP")}
              />
            </div>
          ))
        }
      </div>
      <div class="section-footer"></div>
    </div>

    <a href="#" class="back-to-top-button">
      <i class="fa-solid fa-angle-up"></i>
    </a>

    <script is:inline src="/scripts/script.js"></script>
    <script>
      // フィルタリング操作を監視して、表示されている最後の要素にクラスを付与し直す
      const container = document.querySelector(".article-card-container");

      const updateLastVisible = () => {
        const items = document.querySelectorAll(
          ".article-filter-item",
        ) as NodeListOf<HTMLElement>;
        let lastVisible: HTMLElement | null = null;

        for (const item of items) {
          item.classList.remove("last-visible");
          // display: none でない要素を追跡
          if (item.style.display !== "none") {
            lastVisible = item;
          }
        }

        if (lastVisible) {
          lastVisible.classList.add("last-visible");
        }
      };

      if (container) {
        const observer = new MutationObserver((mutations) => {
          const isStyleChanged = mutations.some(
            (m) => m.type === "attributes" && m.attributeName === "style",
          );
          if (isStyleChanged) {
            updateLastVisible();
          }
        });

        observer.observe(container, {
          attributes: true,
          subtree: true,
          attributeFilter: ["style"],
        });
      }
    </script>
  </body>
</html>

<style>
  /* フィルタリング時の最後の要素に下線を表示 */
  .article-filter-item.last-visible :global(.article-card)::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: var(--white);
  }
</style>
